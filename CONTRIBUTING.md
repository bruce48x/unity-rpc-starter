# Contributing Guide

Mandatory engineering rules for this repo. Target is **Unity 2022 LTS** with **iOS / IL2CPP / HybridCLR**; stability and platform compatibility take priority.

---

## 1. Architecture & Sources

### Assemblies
- `Game.Rpc.Contracts`: RPC interfaces, DTOs, attributes (`RpcService`, `RpcMethod`); **no UnityEngine**.
- `Game.Rpc.Runtime`: transport abstraction + implementations (TCP / WebSocket / KCP / Loopback), framing, RPC core.
  - Unity sources: `Assets/Scripts/Rpc/**`
  - Server sources: `src/ULinkRPC.Runtime/**`
- Unity test assemblies: `*.Tests.Editor` / `*.Tests.PlayMode` (NUnit + Unity Test Framework)
- Server-side .NET projects live under `Server/**` (including `Game.Rpc.Server.Tests`).

No circular dependencies between assemblies.

### Contracts are the single source of truth
- Do NOT duplicate contracts under `Server/**`.
- All contracts live in `Packages/com.bruce.rpc.contracts/`.
- Server projects must include contracts by linking sources:
  ```xml
  <Compile Include="..\..\Packages\com.bruce.rpc.contracts\**\*.cs" />
  ```
- If server changes require a contract update, edit the package, not server-local copies.

---

## 2. Unity / IL2CPP Constraints

Forbidden in Unity client code (including tests):
- `System.Threading.Channels`
- `System.IO.Pipelines`
- `System.Reflection.Emit`
- Runtime code generation
- APIs relying on JIT-only behavior

If an API is common on server-side .NET but not explicitly supported by Unity IL2CPP, treat it as **unsafe**.

### C# version
Unity client code and shared contracts must compile with **C# 9.0** (no C# 10+ syntax).

---

## 3. Async & ValueTask Rules

Allowed `ValueTask` patterns only:
- `return default;` for `ValueTask`
- `return new ValueTask<T>(value);`
- `async` methods returning `ValueTask<T>` with `return value;`

Forbidden:
- `ValueTask.CompletedTask`
- `ValueTask.FromResult(...)`

---

## 4. Transport & Networking

- All transports must implement `ITransport`.
- RPC code must not depend on a specific transport.
- Transport implementations must be cancellation-safe, avoid background thread leaks, and be explicit about disconnect behavior.
- Prefer **LoopbackTransport** for local testing.

---

## 5. Testing

### Unity tests
- NUnit + Unity Test Framework only.
- Live under `Assets/Tests/**`.
- EditMode tests default for RPC/runtime logic; PlayMode only for MonoBehaviour/scene/platform-specific behavior.
- EditMode asmdefs must include:
  ```json
  "optionalUnityReferences": ["TestAssemblies"],
  "includePlatforms": ["Editor"]
  ```
- EditMode tests must live under `Assets/Tests/Editor/**`.
- PlayMode tests must live under `Assets/Tests/PlayMode/**` (or an asmdef not restricted to Editor).
- EditMode test asmdefs should reference only `Game.Rpc.Contracts` and `Game.Rpc.Runtime`.

### Server tests
- `Server/**` uses xUnit and standard .NET test conventions.

### Async Unity tests (critical)
Do **not** use `async Task` with `[Test]`. Use `[UnityTest]` + `IEnumerator`:
```csharp
[UnityTest]
public IEnumerator Example_Async_Test()
{
    var task = RunAsync();
    yield return new WaitUntil(() => task.IsCompleted);
    if (task.IsFaulted)
        throw task.Exception!;
}

private async Task RunAsync()
{
    // async test logic
}
```

### Assertions (Unity tests)
Each Unity test file must include:
```csharp
using NUnitAssert = NUnit.Framework.Assert;
```
And use `NUnitAssert.*` only (no unqualified `Assert.*` or `UnityEngine.Assertions.Assert`).

---

## 6. Code Style & Safety

- Prefer explicit lifetimes (`DisposeAsync`, `StopAsync`).
- Clean up background loops in tests.
- Avoid implicit global state.
- Favor clarity over micro-optimizations in shared infrastructure.

---

## 7. Code Generation

RPC client stubs and Unity test binders are generated by:
```
dotnet run --project Tools/RpcCodeGen --
```
Or use `gen.sh` / `gen.ps1`.

- Generated client stubs go to `Assets/Scripts/Rpc/Generated/` and must be committed.
- Do **not** edit generated files; they will be overwritten.
- Generated code must be deterministic, IL2CPP-friendly, and avoid heavy reflection.

---

## 8. AI / Code Assistant Notes

- Follow all rules above.
- Fix any Unity / IL2CPP violations before committing.
- Prefer changes that preserve assembly boundaries and test coverage.
