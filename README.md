# ULinkRPC (Unity 2022 LTS)

This repository is a starter skeleton for a **strongly-typed RPC** framework for **Unity + .NET**, designed to work with:
- iOS (IL2CPP) and HybridCLR (hot-update)
- Shared Contracts (`interface` + DTO) between client and server
- Transport switchability (TCP / WebSocket / KCP) behind a single abstraction
- Pluggable DTO serialization (MemoryPack by default)

## What is included
- `samples/RpcCall/RpcCall.Unity/Packages/com.bruce.rpc.contracts`: Contracts (Git project; user-defined)
- `samples/RpcCall/RpcCall.Unity/Assets/Scripts/Rpc/Runtime`: Unity runtime + framing + RPC client core
- `samples/RpcCall/RpcCall.Unity/Assets/Scripts/Rpc/Transports`: TCP + WebSocket + KCP transports (client)
- `samples/RpcCall/RpcCall.Unity/Assets/Scripts/Rpc/RpcGenerated`: generated Unity client stubs + test binders (checked in)
- `src/ULinkRPC.Runtime`: NuGet runtime (netstandard2.1 + net8.0)
- `src/ULinkRPC.CodeGen`: code generator (dotnet tool)

## NuGet installation
- Unity side uses NuGetForUnity (OpenUPM).
- Runtime package: `ULinkRPC.Runtime` (targets netstandard2.1 + net8.0).

## Serialization
Default serializer is MemoryPack, but you can switch to JSON (or your own) by providing
an `IRpcSerializer` implementation to both client and server.

MemoryPack is wired via NuGetForUnity. If you want JSON in Unity, install
`System.Text.Json` through NuGetForUnity.

Example (JSON):
```
var serializer = new JsonRpcSerializer();
var client = new RpcClient(transport, serializer);
var server = new RpcServer(transport, serializer);
```

Notes:
- Client and server must use the same serializer.
- DTOs still have `[MemoryPackable]` attributes; they are ignored by JSON.

## Contracts (Git)
Contracts should live in a user-defined Git repo (not NuGet). Keep client/server in sync.

## Transport security (compression / encryption)
Enable compression and/or encryption per transport via `TransportConfig.Security`:

```
var cfg = new TransportConfig
{
    Kind = TransportKind.Tcp,
    Host = "127.0.0.1",
    Port = 20000,
    Security =
    {
        EnableCompression = true,
        CompressionThresholdBytes = 1024,
        EnableEncryption = true,
        EncryptionKeyBase64 = "BASE64_KEY_32_BYTES"
    }
};
```

Notes:
- Client and server must use the same compression/encryption settings and key.
- Encryption uses AES-CBC + HMAC-SHA256; compression uses GZip.

## Code Generation
Stubs are generated by a standalone CLI tool so you can run it from the command line:

```
dotnet run --project src/ULinkRPC.CodeGen/ULinkRPC.CodeGen.csproj --
# or, if installed as a tool:
ulinkrpc-codegen
```

Generated files are written to:
- `samples/RpcCall/RpcCall.Unity/Assets/Scripts/Rpc/RpcGenerated/` (Unity client stubs + Unity EditMode test binders)
They should be committed.

## Packing ULinkRPC.Runtime
```
dotnet pack src/ULinkRPC.Runtime/ULinkRPC.Runtime.csproj -c Release
```

## Tests
1. Open `samples/RpcCall/RpcCall.Unity` in Unity 2022 LTS.
2. Ensure packages resolve (MemoryPack should be present).
3. open `Window` -> `General` -> `Test Runner` ï¼Œ click `EditMode`, click `Run All`

See CONTRIBUTING.md for architecture, testing, and platform constraints.
