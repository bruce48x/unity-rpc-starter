---
alwaysApply: true
---

# Unity Unit Test Rules (NUnit + Unity Test Framework)

## Scope
Applies to all test code under:
- `Assets/Tests/**`
- any assembly ending with `.Tests` / `.Tests.Editor` / `.Tests.PlayMode`

## Assembly Definition (asmdef) rules
### EditMode tests (recommended default)
- EditMode tests MUST live under `Assets/Tests/Editor/**`.
- EditMode test assemblies MUST set:
  - `"includePlatforms": ["Editor"]`
  - `"optionalUnityReferences": ["TestAssemblies"]`
- EditMode test assemblies SHOULD reference only:
  - `Game.Rpc.Contracts`
  - `Game.Rpc.Runtime`
  - `Game.Rpc.Runtime.GeneratedManual` (temporary; remove once Source Generator is integrated)

### PlayMode tests
- PlayMode tests MUST live under `Assets/Tests/PlayMode/**` (or an asmdef not restricted to Editor).
- PlayMode test assemblies MUST include:
  - `"optionalUnityReferences": ["TestAssemblies"]`

## Assert usage (avoid ambiguity)
- Tests MUST use NUnit assertions only.
- Every test file MUST include:
  - `using NUnitAssert = NUnit.Framework.Assert;`
- All assertions MUST use `NUnitAssert.*` (e.g., `NUnitAssert.AreEqual(...)`).
- DO NOT use `Assert.*` without qualification.
- DO NOT use `UnityEngine.Assertions.Assert` in tests.

## Async test rule (critical)
- Due to Unity/NUnit runner compatibility, DO NOT write async tests as `[Test] async Task ...`.
- Any test that needs `await` MUST be implemented as:
  - `[UnityTest] public IEnumerator TestName()`
  - internally run async logic via a `Task` and wait using `WaitUntil`.

### Required async test pattern
Each async test MUST follow this template:

```csharp
using System.Collections;
using System.Threading.Tasks;
using NUnit.Framework;
using NUnitAssert = NUnit.Framework.Assert;
using UnityEngine.TestTools;

public class ExampleTests
{
    [UnityTest]
    public IEnumerator Example_Async_Test()
    {
        var t = RunAsync();

        yield return new WaitUntil(() => t.IsCompleted);

        if (t.IsFaulted)
            throw t.Exception!;
    }

    private async Task RunAsync()
    {
        // async test logic using await
        await Task.Yield();
        NUnitAssert.True(true);
    }
}

